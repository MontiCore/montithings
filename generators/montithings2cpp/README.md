<!-- (c) https://github.com/MontiCore/monticore -->
# montithings2cpp Generator

The `montithings2cpp` generator is MontiThings' main generator that
provides the overall workflow for the generation process.

An explanation of the structure and the concepts used by the
generator can be found in Chapter 5 of [[Kir23]](https://www.se-rwth.de/phdtheses/Diss-Kirchhof-Model-Driven-Development-Deployment-and-Analysis-of-Internet-of-Things-Applications.pdf).

## Where to start? Workflow definition.

The main class is the
[`MontiThingsGeneratorTool`][MontiThingsGeneratorTool] that defines
the overall generation workflow.
The generation consists of steps that carry out the actual tasks.
These steps can be found in the `steps` folder.
Each step carries out an `action` method that gets as input the
current [`GeneratorToolState`][GeneratorToolState].
The [`GeneratorToolState`][GeneratorToolState] defines the information exchanged between steps.
For example, if an early step searches `.mt`-files, the list of found
`.mt`-files  can be exchanged with later steps of the generation
process via the [`GeneratorToolState`][GeneratorToolState].

If you want to add new functionality, you will add a new class
inheriting from [`GeneratorStep`][GeneratorStep] and add it to the workflow
defined in [`MontiThingsGeneratorTool`][MontiThingsGeneratorTool].

## Converting models into code

MontiThings uses multiple methods for converting models into code.
The most common way is using Apache Freemarker.
Using Freemarker, you can define templates that act as a blueprint
for the generated code.
These templates are filled with information from the models to
define code that is different for each component, e.g., a class name.
You can find these templates in the
[`codegen/template`](src/main/java/montithings/generator/codegen/template)
folder.

### Freemarker conventions

We have a few conventions to organize our templates that proved over
time to make it easier to find what you're looking for.
In general, we create a folder for each generated class called
like the generated class.
This gives you a basic idea of where to look when the generated code
doesn't look right.
For example, for each component we generate a `MyComponentNameImpl`
class whose code you can find in the `impl` folder.
Within each folder for a generated class, we create a folder
called `methods`.
It contains the templates for each generated method where each
template is called like the generated method.
For example, if you're looking for the template that generated the
`getState` method of a component, you can find it under
`template/component/methods/GetState.ftl`.

Additionally, for C++, we create exactly 3 files for each generated
class: `Header.ftl`, `Body.ftl`, `ImplementationFile.ftl`.
The `Header` contains the template that generates the code that
ends up in the `.h` file, the `ImplementationFile` does the same for
the `.cpp` file.
The `ImplementationFile` template is usually an almost empty shell
for the `Body` that contains the actual method implementations.
Depending on whether a class has type parameters, the `Body` ends up
in the `.h` or `.cpp` file.

In the `util` folder, you can find additional templates that
encapsulate specific functionalities like build scripts, CMakeFiles,
or statechart behavior.

Most templates start like this:
```
<#-- (c) https://github.com/MontiCore/monticore -->
${tc.signature("comp", "config", "useWsPorts", "existsHWC")}
<#include "/template/component/helper/GeneralPreamble.ftl">
<#include "/template/Copyright.ftl">
```

The signature defines the arguments that the template takes.

**Important: Every template called by `FileGenerator` always
takes `existsHWC` as last argument!**
The `FileGenerator`'s `generate` method can be used in the
generator steps to actually execute the templates.
It automatically handles MontiCore's TOP mechanism and tells the
template via the `existsHWC` method if there is handwritten code
overriding the code generated by the template.
How to handle this situation, e.g., by adding `TOP` to a class name
is up to the template.

The `<#include "/template/component/helper/GeneralPreamble.ftl">` line
adds a general template that contains useful definitions used by many
templates.
For example, it defines access to the collection of helper methods
defined in [`ComponentHelper`](src/main/java/montithings/generator/helper/ComponentHelper.java).
The `<#include "/template/Copyright.ftl">` adds MontiCore's usual
copyright statement to the generated code together with a warning
not to modify generated code manually.

### Prettyprinters

When the generated code has a tree-like structure, templates are not
necessarily the best choice for generating code.
Therefore, MontiThings uses prettyprinters in the
[`prettyprinter`](src/main/java/montithings/generator/prettyprinter)
folder for its embedded behavior language.
These prettyprinters use MontiCore's visitor implementation.
A discussion of MontiCore's visitors can be found in the
[MontiCore Handbook](https://monticore.de/handbook.pdf).

## Runtime Environment (RTE)

All parts of the generated C++ projects that are the same for all
components are defined in the runtime environment (RTE).
You can find the RTE under `src/main/ressources/rte`.
The RTE's code is copied as-is to the generated projects.
Refer to [it's README](src/main/resources/rte/README.md) for more
information.


[GeneratorStep]: src/main/java/montithings/generator/steps/GeneratorStep.java
[GeneratorToolState]: src/main/java/montithings/generator/data/GeneratorToolState.java
[MontiThingsGeneratorTool]: src/main/java/montithings/generator/MontiThingsGeneratorTool.java